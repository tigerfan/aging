# 产品01：夜间离床风险预测地垫网络（详细设计实现文档）

## 0. 文档信息
- 文档版本：v1.0
- 目标读者：产品经理、嵌入式工程师、算法工程师、App工程师、测试与实施团队
- 部署形态：家庭版（单户）/机构版（多房间）

## 1. 建设目标与范围
### 1.1 业务目标
1. 将“跌倒后报警”前移为“离床前风险预测”。
2. 降低夜间跌倒事件与无效巡房成本。
3. 在不引入摄像头隐私争议的前提下实现高可靠监测。

### 1.2 范围边界
- **In Scope**：起身意图识别、路径灯光联动、超时未回床告警、家属通知。
- **Out of Scope**：临床诊断、院内急救替代、白天全时行为监控。

## 2. 用户角色与核心场景
- 老人用户：夜间2~5次起夜，行动慢、平衡能力下降。
- 家属用户：希望减少“假警报惊扰”。
- 护理人员：机构夜间值守，需要批量房间风险看板。

场景切片：
1. 22:00~06:00离床频发时段。
2. 路径照明不足且地面湿滑。
3. 离床后长时间未回床（可能跌倒或突发不适）。

## 3. 功能需求规格
### 3.1 Must
- FR-01：识别“卧床 -> 起身意图 -> 离床 -> 回床”状态。
- FR-02：起身意图高风险时自动触发路径柔光照明。
- FR-03：离床超时分级告警（语音提醒、家属推送、护理端升级）。

### 3.2 Should
- FR-04：步态稳定性评分（近7天趋势）。
- FR-05：个体阈值自适应（夜尿频次、行动速度、慢病状态）。

### 3.3 Could
- FR-06：睡眠报告联动（离床次数与睡眠片段化指数）。

## 4. 非功能与质量指标
- 端到端告警延迟：< 2s（本地提醒）/ < 5s（远程通知）。
- 误报率：< 5%。
- 漏报率：< 3%。
- 可用性：边缘网关月可用性 >= 99.5%。
- 断网策略：本地闭环可运行，网络恢复后补传事件。

## 5. 总体架构设计
```text
压感地垫节点(卧室/走廊/卫浴)
   + 毫米波节点
          -> BLE Mesh
              -> 边缘网关(状态机+规则引擎)
                  -> 家属App / 护理看板 / 照明控制器
```

分层说明：
1. 感知层：足压重心、微多普勒、停留时长。
2. 决策层：状态机 + 风险评分 + 规则编排。
3. 执行层：灯光、语音、通知。
4. 服务层：设备管理、日志、OTA。

## 6. 硬件设计
### 6.1 节点组成
- 压阻传感膜（区域阵列）
- 60GHz毫米波传感器
- 低功耗MCU
- BLE Mesh通信模块
- 备用电池（断电可持续8小时）

### 6.2 机械与安装
- 地垫厚度<6mm，边缘防翘起设计。
- 卫浴区防水等级IP65。
- 采用定位夹具，避免位移导致误报。

## 7. 软件模块设计
1. `SensorCollector`：采集/去噪/时钟对齐。
2. `StateMachineEngine`：四态切换与超时计时。
3. `RiskScoringService`：个体化风险评分。
4. `ActuatorOrchestrator`：照明与语音联动。
5. `NotificationService`：多级通知和升级策略。
6. `DeviceManager`：心跳监测、OTA、配置下发。

## 8. 数据模型与存储
### 8.1 核心事件
- `BedIntentEvent { user_id, ts, intent_score, confidence }`
- `BedExitEvent { ts, room_zone, gait_score }`
- `TimeoutEvent { elapsed_sec, level, action_taken }`

### 8.2 数据留存策略
- 原始高频数据：本地滚动24小时。
- 事件摘要：云端180天。
- 敏感数据：按最小必要原则保存。

## 9. 算法与规则实现
### 9.1 特征工程
- 足压重心偏移速度
- 起身前微动作频率
- 步态节律稳定性
- 夜间历史行为基线偏差

### 9.2 风险评分
`Risk = w1*intent + w2*gait_instability + w3*env_risk + w4*history_shift`
- 初始阈值0.72，按7日反馈自校准。

### 9.3 规则引擎
- R1：意图高风险 -> 预照明。
- R2：离床180秒未回 -> 一级提醒。
- R3：离床300秒未回 -> 二级通知家属。
- R4：夜间连续3次异常 -> 次日护理随访任务。

## 10. 接口定义
### 10.1 MQTT主题
- 发布：`elderly/room/{room_id}/risk`
- 订阅：`elderly/room/{room_id}/command`

### 10.2 App API
- `POST /api/v1/risk/ack`
- `GET /api/v1/night-report?user_id=&date=`
- `POST /api/v1/escalation/config`

## 11. 交互流程与异常流程
### 11.1 正常流程
1. 检测起身意图。
2. 触发走廊-卫浴柔光。
3. 监测离床过程。
4. 回床后自动结束会话并记录。

### 11.2 异常流程
- 检测长时间静止 + 未回床：
  - 先语音提醒。
  - 无响应则通知家属。
  - 机构版触发护理站派单。

## 12. 安全与合规
- 端侧优先推理，避免上传可识别行为轨迹。
- 传输加密：AES-GCM + TLS。
- 权限模型：老人本人、家属、护理员分级可见。
- 文案合规：明确“风险辅助，不构成医疗诊断”。

## 13. 测试与验收
### 13.1 测试项
- 单元测试：状态机切换正确率。
- 集成测试：照明-告警链路稳定性。
- 场景测试：宠物误触、访客走动、地垫位移。

### 13.2 验收标准
- 起身意图识别召回率 >= 95%。
- 误报率 < 5%。
- 超时告警到达率 >= 99%。

## 14. 实施计划
- Phase 1（0~8周）：单卧室MVP。
- Phase 2（9~12周）：20户试点与阈值调优。
- Phase 3（13~24周）：社区批量部署与运维平台上线。

## 15. 风险与缓解
- 风险：宠物/访客导致误判。  
  缓解：多节点一致性校验 + 体重/步态模式过滤。
- 风险：安装不规范导致检测盲区。  
  缓解：安装向导 + 自检工单。
- 风险：用户对夜间提醒反感。  
  缓解：个体化提醒强度与静默时段配置。
